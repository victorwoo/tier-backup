# 软链接备份功能使用指南

## 概述

软链接备份功能是tier-backup的高级特性，当检测到目录内容未发生变化时，自动创建软链接而不是重复备份，从而极大节省磁盘空间和备份时间。

## 工作原理

### 哈希值计算
脚本使用MD5哈希算法计算目录的"指纹"：
- 文件路径
- 文件修改时间
- 文件大小
- 文件数量

### 变化检测
1. 计算当前目录的哈希值
2. 与最后一次备份的哈希值比较
3. 如果哈希值相同，创建软链接
4. 如果哈希值不同，创建新的实际备份

### 软链接创建
- 软链接指向最后一次有实际数据的备份
- 元数据文件记录软链接信息
- 支持目录备份和压缩备份的软链接

## 启用软链接功能

在 `back_config.json` 中设置：

```json
{
    "enable_symlink": true
}
```

## 系统要求

### Windows
- 需要管理员权限
- 支持NTFS文件系统
- Windows 7/8/10/11

### macOS
- 默认支持软链接
- 无需特殊权限
- macOS 10.14 或更高版本

### Linux
- 默认支持软链接
- 无需特殊权限
- 大多数 Linux 发行版

## 文件结构示例

### 启用软链接前
```
backup/
├── hourly/
│   ├── 2025-01-15_0900/          # 1GB
│   ├── 2025-01-15_1000/          # 1GB (相同内容)
│   ├── 2025-01-15_1100/          # 1GB (相同内容)
│   └── 2025-01-15_1200/          # 1GB (相同内容)
# 总大小：4GB
```

### 启用软链接后
```
backup/
├── hourly/
│   ├── 2025-01-15_0900/          # 1GB (实际备份)
│   ├── 2025-01-15_1000 -> 2025-01-15_0900/  # 几KB (软链接)
│   ├── 2025-01-15_1100 -> 2025-01-15_0900/  # 几KB (软链接)
│   └── 2025-01-15_1200 -> 2025-01-15_0900/  # 几KB (软链接)
# 总大小：约1GB
```

## 性能优势

### 磁盘空间节省
- **相同内容**：节省90%以上空间
- **部分变化**：根据变化程度节省空间
- **完全变化**：无额外开销

### 备份时间
- **软链接创建**：几乎瞬间完成
- **实际备份**：正常时间
- **哈希计算**：几秒到几分钟（取决于文件数量）

### 系统资源
- **CPU使用率**：哈希计算时中等
- **内存使用**：较低
- **I/O操作**：显著减少

## 配置选项

### 基础配置
```json
{
    "enable_symlink": true
}
```

### 高级配置（在代码中修改）
```python
# 修改哈希计算的最大文件数
def calculate_directory_hash(source_dir, max_files=1000):
    # 增加max_files可以提高准确性，但会降低性能
```

## 日志示例

### 软链接创建
```
2025-01-15 10:00:01 - INFO - 当前目录哈希: 6bd51663... (文件数: 5)
2025-01-15 10:00:01 - INFO - 检测到目录内容未变化，创建软链接备份
2025-01-15 10:00:01 - INFO - 创建软链接备份: D:\backup\hourly\2025-01-15_1000 -> D:\backup\hourly\2025-01-15_0900
```

### 实际备份创建
```
2025-01-15 11:00:01 - INFO - 当前目录哈希: 8f2a1b4c... (文件数: 6)
2025-01-15 11:00:01 - INFO - 检测到目录内容已变化，创建实际备份
2025-01-15 11:00:15 - INFO - hourly备份成功: D:\backup\hourly\2025-01-15_1100
```

## 故障排除

### 软链接创建失败
1. **权限问题**：
   ```bash
   # Windows：以管理员身份运行
   # macOS/Linux：检查文件权限
   ```

2. **文件系统不支持**：
   - 确保使用支持软链接的文件系统
   - Windows：NTFS
   - macOS：APFS, HFS+
   - Linux：ext4, xfs等

3. **路径问题**：
   - 检查源路径和目标路径是否正确
   - 确保路径不包含特殊字符

### 哈希值不一致
1. **文件修改时间变化**：
   - 这是正常现象
   - 脚本会创建新的实际备份

2. **文件数量过多**：
   - 默认限制1000个文件
   - 可以在代码中修改max_files参数

### 软链接失效
1. **原始备份被删除**：
   - 软链接指向的备份被清理
   - 需要重新创建实际备份

2. **文件系统问题**：
   - 检查磁盘错误
   - 运行文件系统检查

## 最佳实践

### 1. 系统配置
- 使用支持软链接的文件系统
- 确保有足够的权限
- 定期检查软链接有效性

### 2. 性能优化
- 合理设置max_files参数
- 避免在备份时修改源文件
- 监控哈希计算时间

### 3. 监控和维护
- 定期检查日志文件
- 验证软链接的有效性
- 监控磁盘空间使用情况

### 4. 备份策略
- 结合压缩备份使用
- 根据文件变化频率调整备份间隔
- 定期创建完整备份

## 测试软链接功能

运行测试脚本验证功能：
```bash
python test_symlink.py
```

测试内容包括：
- 系统软链接支持
- 哈希值一致性
- 软链接创建
- 备份模拟

## 注意事项

### 重要提醒
1. **Windows权限**：必须以管理员身份运行
2. **macOS/Linux权限**：通常无需特殊权限
3. **软链接依赖**：删除原始备份会导致软链接失效
4. **跨文件系统**：软链接可能跨文件系统工作
5. **备份完整性**：软链接不影响数据完整性

### 限制
1. **文件数量**：默认最多1000个文件参与哈希计算
2. **哈希算法**：使用MD5，足够用于变化检测
3. **系统兼容性**：需要操作系统支持软链接

### 建议
1. **首次使用**：先在小目录上测试
2. **生产环境**：充分测试后再部署
3. **监控**：定期检查软链接状态
4. **备份**：保留重要的实际备份 